<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="user-scalable=no, width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0"
    />
    <link rel="icon" href="https://mirea.xyz/img/icons/round/round_192x192.png" />

    <meta name="theme-color" data-meta-name="theme-color" content="#03589C" />
    <link rel="icon" sizes="512x512" href="https://mirea.xyz/img/icons/round/round_512x512.png" />
    <link rel="icon" sizes="192x192" href="https://mirea.xyz/img/icons/round/round_192x192.png" />

    <meta name="apple-mobile-web-app-status-bar-style" data-meta-name="theme-color" content="#03589C" />
    <link rel="apple-touch-icon" sizes="180x180" href="https://mirea.xyz/img/icons/round/round_180x180.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="https://mirea.xyz/img/icons/round/round_152x152.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="https://mirea.xyz/img/icons/round/round_120x120.png" />
    <link rel="apple-touch-icon" sizes="76x76" href="https://mirea.xyz/img/icons/round/round_76x76.png" />
    <link rel="apple-touch-icon" sizes="60x60" href="https://mirea.xyz/img/icons/round/round_60x60.png" />
    <link
      rel="apple-touch-icon-precomposed"
      sizes="180x180"
      href="https://mirea.xyz/img/icons/round/round_180x180.png"
    />
    <link
      rel="apple-touch-icon-precomposed"
      sizes="152x152"
      href="https://mirea.xyz/img/icons/round/round_152x152.png"
    />
    <link
      rel="apple-touch-icon-precomposed"
      sizes="120x120"
      href="https://mirea.xyz/img/icons/round/round_120x120.png"
    />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://mirea.xyz/img/icons/round/round_76x76.png" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://mirea.xyz/img/icons/round/round_60x60.png" />

    <meta name="msapplication-TileColor" data-meta-name="theme-color" content="#03589C" />
    <meta name="msapplication-TileImage" content="https://mirea.xyz/img/icons/round/round_144x144.png" />

    <title>MSS Panel</title>

    <style>
      @font-face {
        font-family: "Roboto";
        src: url("/params-panel/static/Roboto-Medium.ttf");
      }

      * {
        box-sizing: border-box;
      }

      body {
        padding: 0;
        margin: 0;

        font-family: Roboto, Arial, "Helvetica Neue", Helvetica, sans-serif;
        font-weight: 500;
        line-height: 1.3em;

        background-color: #000;
        color: #e1e1e1;
      }

      .panel {
        display: block;
        position: relative;

        width: 90%;
        max-width: 800px;

        padding: 16px;
        margin: 50px auto;

        background-color: #151515;
        border-radius: 8px;
      }

      .panel.panel_logs {
        min-width: 90%;
      }

      .panel__header {
        display: block;

        width: fit-content;
        margin: 0 auto 20px;

        font-size: 48px;
        letter-spacing: -0.03em;
        line-height: 1.2em;
        text-align: center;

        user-select: none;
      }

      .panel__header:last-child {
        margin-bottom: 0;
      }

      .panel__header_link,
      .panel__header_link:visited {
        font-size: 32px;
        color: #e1e1e1;
        text-align: center;
      }

      .panel__header_button {
        border-bottom: 2px dotted currentColor;

        cursor: pointer;
        -webkit-touch-callout: none;
      }

      .panel__params-table {
        border-spacing: 0;
        border-collapse: collapse;

        margin: 0 auto;
      }

      .panel__params-table th,
      .panel__params-table td {
        border: 1px solid #444;
        padding: 8px 20px;

        line-height: 26px;
      }

      .panel__value-btn {
        display: inline;
        float: right;

        margin: 0 0 0 16px;
        height: 26px;
        padding: 6px 10px;

        cursor: pointer;
        outline: none;
        border: none;
        border-radius: 4px;

        font-size: 14px;
        font-family: "Roboto", Arial, "Helvetica Neue", Helvetica, sans-serif;
        font-weight: 500;
        line-height: 1em;
        text-transform: uppercase;

        background-color: #e1e1e1;
        color: #121212;

        user-select: none;
      }

      #logs-panel {
        display: none;
      }

      .logs-change-buttons-container {
        display: flex;
        flex-direction: row;
        justify-content: center;
        flex-wrap: nowrap;
        align-items: center;

        width: 100%;
      }

      .logs-change-page-button {
        display: block;
        position: relative;

        margin: 8px;
        padding: 10px 12px;

        border-radius: 7px;
        background-color: #e1e1e1;
        cursor: pointer;

        color: #121212;
        font-size: 15px;
        line-height: 15px;
        font-weight: 500;
        white-space: nowrap;
        text-transform: uppercase;
        user-select: none;
      }

      .panel__logs-table {
        border-spacing: 0;
        border-collapse: collapse;

        margin: 0 auto;

        width: 100%;
      }

      .panel__logs-table th {
        border: 1px solid #444;
        padding: 8px;

        line-height: 26px;
      }

      .panel__logs-table td {
        border: 1px solid #444;
        padding: 8px;

        vertical-align: top;
        text-align: center;
      }

      .panel__logs-table td.panel__table__logs-messages {
        text-align: left;
      }

      .panel__table__logs-messages pre {
        font-family: Consolas, "Courier New", monospace;
        font-size: 13px;

        margin: 0 0 8px;
      }

      .panel__table__logs-messages pre:last-child {
        margin-bottom: 0;
      }
    </style>
  </head>

  <body>
    <div class="panel">
      <a class="panel__header panel__header_link" href="/grafana/d/mss/mss-backend-dashboard">Open Grafana</a>
      <span class="panel__header panel__header_link panel__header_button" id="show-logs-button">Show recent logs</span>
    </div>

    <div class="panel" id="params-panel">
      <h1 class="panel__header">MSS Params</h1>
      <table class="panel__params-table">
        <thead>
          <th>Parameter</th>
          <th>Value</th>
        </thead>
        <tbody id="panel-params-table-body"></tbody>
      </table>
    </div>

    <div class="panel panel_logs" id="logs-panel">
      <div class="logs-change-buttons-container">
        <span class="logs-change-page-button" id="logs-show-previous-button">Newer logs</span>
        <span class="logs-change-page-button" id="logs-show-next-button">Later logs</span>
      </div>

      <table class="panel__logs-table">
        <thead>
          <th>№</th>
          <th>Timestamp</th>
          <th>Error</th>
          <th>Messages</th>
          <th>Tag</th>
        </thead>
        <tbody id="panel-logs-table-body"></tbody>
      </table>
    </div>

    <script>
      const LOGS_STORAGE = {
        PER_PAGE: 50,
        CURRENT_PAGE: 0,

        /** @type {Map<number, any[]>} */
        PAGES: new Map()
      };

      /**
       * @param {string} name
       * @param {any} value
       */
      function updateParam(name, value) {
        fetch("/params-panel/api/params/set", {
          method: "POST",
          body: JSON.stringify({ name, value })
        })
          .then((res) => {
            if (!res.ok)
              return res.text().then(
                (text) => Promise.reject(new Error(`Status code ${res.status} ${res.statusText} – ${text}`)),
                () => Promise.reject(new Error(`Status code ${res.status} ${res.statusText}`))
              );

            alert(`Parameter ${name} was updated`);
          })
          .catch((e) => {
            alert(e instanceof Error ? e.message : e);
          });
      }

      function listAllParams() {
        window.addEventListener("load", () => {
          fetch("/params-panel/api/params/list", { method: "GET" })
            .then((res) => {
              if (!res.ok)
                return res.text().then(
                  (text) => Promise.reject(new Error(`Status code ${res.status} ${res.statusText} – ${text}`)),
                  () => Promise.reject(new Error(`Status code ${res.status} ${res.statusText}`))
                );

              return res.json();
            })
            .then(
              /** @param {{ name: string, value: any }[]} params */ (params) => {
                const tableBody = document.getElementById("panel-params-table-body");

                params.forEach(({ name, value }) => {
                  const tr = document.createElement("tr");
                  const [nameCell, valueCell] = [document.createElement("td"), document.createElement("td")];
                  nameCell.innerText = name;

                  const valueTextElem = document.createElement("span");
                  valueTextElem.classList.add("panel__value-text");
                  valueTextElem.innerText = value;

                  const valueTextEditBtn = document.createElement("button");
                  valueTextEditBtn.classList.add("panel__value-btn");
                  valueTextEditBtn.innerText = "Edit";

                  valueCell.append(valueTextElem, valueTextEditBtn);

                  valueTextEditBtn.addEventListener("click", () => {
                    const newValue = prompt("Enter new value", value);
                    valueTextElem.innerText = newValue;
                    updateParam(name, newValue);
                  });

                  tr.append(nameCell, valueCell);
                  tableBody.append(tr);
                });
              }
            )
            .catch((e) => {
              alert(e instanceof Error ? e.message : e);
            });
        });
      }

      function listAllLogs() {
        const paramsPanel = document.getElementById("params-panel");
        const logsPanel = document.getElementById("logs-panel");
        const logsTableBody = document.getElementById("panel-logs-table-body");

        if (!logsTableBody) return;

        if (paramsPanel) paramsPanel.style.display = "none";
        if (logsPanel) logsPanel.style.display = "block";

        fetch(
          `/params-panel/api/logs/list?limit=${LOGS_STORAGE.PER_PAGE}&skip=${
            LOGS_STORAGE.CURRENT_PAGE * LOGS_STORAGE.PER_PAGE
          }`,
          {
            method: "GET"
          }
        )
          .then((res) => {
            if (!res.ok)
              return res.text().then(
                (text) => Promise.reject(new Error(`Status code ${res.status} ${res.statusText} – ${text}`)),
                () => Promise.reject(new Error(`Status code ${res.status} ${res.statusText}`))
              );

            return res.json();
          })
          .then(
            /** @param {{ isError: boolean, args: string[], tag: string, date?: string }[]} logs */ (logs) => {
              logsTableBody.innerHTML = null;

              logs.filter(Boolean).forEach((log, index) => {
                const row = document.createElement("tr");

                const indexCell = document.createElement("td");
                indexCell.innerText = LOGS_STORAGE.CURRENT_PAGE * LOGS_STORAGE.PER_PAGE + index + 1;

                const timestamp = document.createElement("td");
                if (log.date) {
                  try {
                    timestamp.innerText = new Date(log.date).toISOString();
                  } catch (_) {
                    timestamp.innerText = log.date;
                  }
                } else timestamp.innerText = "";

                const isError = document.createElement("td");
                isError.innerText = log.isError ? "🔴" : "";

                const messages = document.createElement("td");
                messages.classList.add("panel__table__logs-messages");
                if (Array.isArray(log.args))
                  log.args.forEach((arg) => {
                    const pre = document.createElement("pre");
                    if (typeof arg === "string") pre.innerText = arg;
                    else {
                      try {
                        pre.innerText = JSON.stringify(arg, null, 2);
                      } catch (_) {
                        pre.innerText = `${arg}`;
                      }
                    }
                    messages.appendChild(pre);
                  });

                const tag = document.createElement("td");
                tag.innerText = log.tag;

                row.append(indexCell, timestamp, isError, messages, tag);
                logsTableBody.appendChild(row);
              });
            }
          );
      }

      if (new URL(window.location.href).searchParams.get("code")) window.location.assign("/");
      else {
        listAllParams();

        document.getElementById("show-logs-button")?.addEventListener("click", () => {
          listAllLogs();

          document.getElementById("logs-show-next-button")?.addEventListener("click", () => {
            LOGS_STORAGE.CURRENT_PAGE++;
            listAllLogs();
          });
          document.getElementById("logs-show-previous-button")?.addEventListener("click", () => {
            if (LOGS_STORAGE.CURRENT_PAGE > 0) {
              LOGS_STORAGE.CURRENT_PAGE--;
              listAllLogs();
            }
          });
        });
      }
    </script>
  </body>
</html>
